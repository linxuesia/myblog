## 安装

首先确保安装好`node`环境，全局安装了`vue-cli`。进入项目文件夹下，或者新建一个空的文件夹，执行`vue init mpvue/mpvue-quickstart my-project `，初始化 mpvue 的模板。初始化的选项和`vue-cli`的初始化差不多，根据需要自行选择，默认的话就一直按回车就好啦。  

初始化完成之后，执行`npm i`重新安装一下项目依赖，然后执行`npm run dev`项目就正常运行了。



## 运行项目

打开微信开发者工具可以预览效果，因为在微信开发者编辑器里面开发有点不太智能，所以我们可以把编辑器选项关掉，只显示调试和预览。然后用自己熟悉的开发工具打开项目，因为它用的是`webpack`编译加载热替换，所以修改了之后也能实时刷新。

需要注意的是，每次新建一个页面之后，需要重新开启`npm run dev`来编译，也很好理解，入口文件都发生变化了嘛，肯定要重新编译啊。



## 项目结构分析

和`vue-cli`的文档完全一样，src 目录放资源，static 目录放置静态资源，如图片、字体等，所以有过`vue-cli`项目开发经验的朋友会觉得非常好上手，基本上使用是一样一样的~

它主要是在 webpack 编译的过程中，将文件打包成微信小程序默认的文件夹格式，有兴趣的可以研究一下它的 webpack 配置文件，动手能力强的也可以自己配置。webpack 没那么熟练的话，就用初始化的模板就行了，是已经配置好的，看下代码理解一下思路也是OK的，这样也节省时间。

在 src 文件夹的根路径下，App.vue编译出来的就是对应小程序里面的 app.js 和 app.wxss 。main.js 输出的代码会被编译进 app.json ，用来做一些全局的配置，比如`window`和`tab`配置，写法和小程序一样的，但是小程序是以 json 的形式，而 mpvue 里面是在 js 文件里面，所以是对象的写法，即不加双引号，其他都一样。



## mpvue 与 vue 语法异同

* `v-html`指令不能用

* 不支持使用 vue 过滤器

* 列表渲染在嵌套渲染的时候，必须使用不同的 index 和 item 别名。

* 不支持在组件上直接写 class 类名，在 vue 组件里面写它会和组件内的顶级元素的class合并，但是在 mpvue 里面不能用这种写法，组件的类名只能在组件上面定义。

* 不能用 filter 过滤器，如果类似电话号码设置中间四位隐藏这种，暂时想到的方法是在实例里面写一个方法，但是不是全局的，用到的页面都要写一个，应该可以全局注册事件？

* mpvue 不能在子组件里面嵌套组件，这样稍微有那么一丢丢的不方便。

* 不论是用小程序的生命周期函数 onLoad 这些，或者是用 vue 的生命周期函数 mounted 这些，`this`对象的内容都是一样的。

* 不能使用 v-cloak、transition

* 虽然 mpvue 也可以使用 vue 的生命周期函数，但是稍微有所不同，官方文档上有提到一点：

  > 同 vue，不同的是我们会在小程序 onReady 后，再去触发 vue mounted 生命周期 

   但是我发现除了 mounted 之外，还有一个就是 created ，在 h5 页面里面，只有页面载入，实例被创建才会触发，但是在 mpvue 里面，没有进入那个页面也会触发 created 。也就是说进入小程序之后，每个页面的 created 函数都会被触发，所以有关于页面加载之后的请求以及函数都放在 mounted 里面。

  

# memo

* 小程序tab下面的图标的图片没有的话 不能编译

* 跳转页面还是用a链接，会编译成navigator组件，用相对路径的写法`'../page/main'`

* 那么如果是 js 跳转呢，怎么写？location.href 吗还是用小程序的 api 呢？只能用小程序的 api，因为小程序里面没有 window 对象呀。

* data 里面尽量不要放冗余数据，比如后台返回一堆数据给你，你需要的只有其中几个，就只取其中几个，不要全部赋值到 data 上面，不然速度会变慢。

* 无法给 open-data 添加 class 属性，所以要定义样式的话，用元素裹起来，比如头像。

* **在css里面使用背景图片路径，‘/static/img/img.jpg’，使用这种绝对路径，不报错，但是图片没显示出来？如果使用‘../../static/img/img’这种路径在html里面可以正常显示，在css里面做为样式就无法引入。**

* vuex - 官方demo是在每个页面文件夹下面放一个 store.js ，然后把这个 store 挂载到每个页面的 Vue 实例上面，但是个人觉得没什么必要用这个了，因为 mpvue 不能嵌套子组件，那么一个页面最多两层组件，父子组件使用 props 和 emit 来通讯就好了，用不上 vuex。根据项目需求来吧反正还是。如果你的一个页面上子组件非常多，且需要共享状态的话，用 vuex 应该也是会更加方便一些。

* 行内元素用 span 来写，尽量不要用`<b></b>`这种行内标签，会被编译成块状元素，影响你的布局。如果要用的话，你就自己在样式里面定义，`._b{ display: inline-block; }`。我觉得是没啥必要这样了，因为用这样的标签本来是为了代码更语义化，但是这里编译出来的元素已经变成小程序的组件了，无所谓语义化。

* 在使用表单元素 radio 、checkbox 的时候，要用小程序的`<checkbox-group>`、`<radio-group>`，不然没有办法监听改变的事件。

* 虽然说我们在跳转页面的时候写的是 a 元素，但实际上 mpvue 是把它编译成了小程序的 navigator 组件，所使用的还是小程序的路由跳转，所以我们也不能用 window.location.href 来获取页面的链接，因为小程序里面是没有 window 对象的噢！

* 小程序 css 样式不能用本地的图片 只能用在线的图片 

* 直接使用小程序的地址选择组件，会出现样式混乱，要用css设置一下样式。获取数据不能使用`e.detail.value`，变成`e.mp.detail.value`

* 使用 scroll-view 的时候一定要先设置固定的高度和宽度，不然没办法触发 scroll 事件

* 有一个 mpvue 的坑，如果将父元素设置成`position:relative`，那么其子元素将上的点击事件不会有效果，包括原生组件例如选择地区，都不会有效果。

  

# mpvue是移动端和小程序端共用代码吗？

答案是不。它提供的最多是类似 vue 的开发体验，让你的开发过程更顺手，尽量达到一致的调试。如果用 mpvue 开发的小程序，然后想要复用到 h5 ，我觉得难度有点大。如果你追求的效果是一份代码三端（web、App、微信小程序）复用的话，可以去了解一下京东出的多端统一开发框架 Taro。

如果要实现的话，你就必须要做到，不用微信小程序的自带组件如 image 、swiper 、select 、scroll-view 等等，这就比较难做到了。其次你还不能用小程序的所有 api ，比如 showToast 这些很基础的。当然这些你都可以封装一层，通过判断是 h5 还是微信小程序来显示小程序或者 h5 的组件。但是有一个表单组件，mpvue 官方文档推荐直接使用小程序的表单组件，多了一层 `checkbox-group`和`radio-group`。

此外，还有按钮的点击态，在 h5里面只要写一个`a:active`，在小程序里面要用 `hover-class`，不过这个倒是不影响。

网络请求，可以使用微信小程序的网络请求 api，如果不想用小程序自带的，可以用 fly.js ，别的类似 axios 这种都不能用，因为在微信里面是没有 XMLHttpRequest  对象这种东西的。

如果想要实现复用代码的话，可以定义一个全局变量 isWechat，用这个值来判断是小程序还是 h5，对于所有的需要用到小程序的 api 和组件的，调用封装的公共方法和组件，以这个全局变量来做判断。比如跳转页面，这是我的实现方式：

```
function navigator(url,params){
  let _url = url+'?';
  let prams = '';
  for(item in Object.keys(params)){
    params += item+'='+params[item]+'&';
  }
  prams.slice(0,prams.length-1);
  if(isWechat){
    wx.navigateTo({url:_url+prams});
  }else{
    window.location.href = _url+prams;
  }
}
```

这样可以看到参数是成功的传递出去了，那怎么获取参数呢？获取参数有两种方式，一种是使用小程序的生命周期函数 onLoad ，这个函数传递的option参数就是页面的参数。当然如果按照尽量不用小程序 api 的原则，你可以继续使用 vue 的生命周期函数 mounted，然后用`this.$root.$mp.query`来获取。下面是官方文档的说法：

>在所有 页面 的组件内可以通过 `this.$root.$mp.query` 进行获取。 



# 一部分实现原理

* 写 p a ，这种 html 标签，小程序不支持，mpvue 会把它们统统编译成 view._p 这种形式，即把不能识别的 html 标签转变成类名，替换成 小程序的组件，同样的，样式在编译的时候，会把标签选择器也编译成类选择器。块状元素编译成小程序对应的块状元素`<view>`、行内元素编译成`<label>`。
* 跳转页面的时候我们写成 a 元素，mpvue 会编译成 navigator 小程序路由组件。